---
layout:     post
title:      "å¸¦æƒè½®è¯¢è´Ÿè½½å‡è¡¡æ¢è®¨"
subtitle:   " "
description: " "
date:       2024-09-01
author:     "MJJ"
published: true 
tags:
    - è´Ÿè½½å‡è¡¡
---

# å¸¦æƒè½®è¯¢è´Ÿè½½å‡è¡¡ä¸šåŠ¡åœºæ™¯

è´Ÿè½½å‡è¡¡æ˜¯åœ¨è¯·æ±‚èµ„æºæ—¶ï¼Œå½“èµ„æºæœ‰å¤šä¸ªï¼Œæˆ‘ä»¬åº”è¯¥è¯·æ±‚å“ªä¸€ä¸ªæ‰èƒ½è®©èµ„æºåˆ©ç”¨ç‡æœ€å¤§åŒ–çš„æ–¹æ³•ã€‚

è½®è¯¢æ˜¯æœ€ç®€å•ç²—æš´çš„ä¸€ç§ç­–ç•¥ï¼Œè¿™ç§ç­–ç•¥æŠŠæ¯ä¸ªèµ„æºéƒ½è¯·æ±‚ä¸€éï¼Œæœ€å¤§çš„å¥½å¤„æ˜¯æ¯ä¸ªèµ„æºæ‰¿å—çš„è¯·æ±‚é‡éƒ½ä¸€æ ·ã€‚

è€Œå¸¦æƒè½®è¯¢è´Ÿè½½å‡è¡¡ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„å…¶ä¸­ä¸€ç§ç­–ç•¥ï¼Œå®ƒçš„ä½¿ç”¨åœºæ™¯æ˜¯å½“å¤šä¸ªèµ„æºå¯ä»¥æ‰¿å—çš„è¯·æ±‚é‡ä¸åŒï¼ˆä¹Ÿå°±æ˜¯ç³»ç»Ÿçš„æ€§èƒ½æœ‰å·®å¼‚ï¼‰æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥åƒç®€å•è½®è¯¢ä¸€æ ·è®©å®ƒä»¬æ‰¿æ‹…ç›¸åŒé‡çš„è¯·æ±‚ï¼Œè€Œæ˜¯é’ˆå¯¹æ¯ä¸ªèµ„æºä¸åŒçš„æ‰¿è½½é‡å»è¯·æ±‚å®ƒä»¬ï¼Œè¿™æ ·æ‰å¯ä»¥è®©æ¯ä¸ªèµ„æºè¢«å……åˆ†çš„åˆ©ç”¨ã€‚

æ¥ä¸‹æ¥ä»‹ç»ä¸‰ç§å®ç°å¸¦æƒè½®è¯¢çš„æ–¹æ³•ã€‚

# å–éšæœºå€¼æ³•

è¿™ç§æ–¹æ³•æ˜¯æœ€ä¸é è°±çš„æ–¹æ³•ğŸ¤£ï¼Œä½†ä¹Ÿæ˜¯åŠå…¶å®¹æ˜“å®ç°çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å–éšæœºå€¼ï¼ŒæŠŠéšæœºå€¼åˆ†ä¸ºå‡ ä¸ªåŒºé—´ï¼Œæ¯ç§èµ„æºå¯¹åº”ä¸€ä¸ªåŒºé—´ï¼ŒåŒºé—´é•¿åº¦å°±è¡¨ç¤ºèµ„æºå¯¹åº”çš„æƒå€¼ã€‚

**ä»£ç å®ç°**
```java
public class RandomWeightLoadBalance {  
  
    // keyï¼šæœåŠ¡id  valueï¼šæƒå€¼  
    private final static Map<Integer, Integer> services = new ConcurrentHashMap<>();  
  
    static {  
        // åˆå§‹åŒ–ä¸‰ä¸ªæœåŠ¡  
        services.put(1,1);  
        services.put(2,2);  
        services.put(3,3);  
    }  
  
    public static int loadBalance(){  
        // è®¡ç®—æ€»æƒå€¼  
        int countWeight = 0;  
        for(Map.Entry<Integer,Integer> service : services.entrySet()){  
            countWeight += service.getValue();  
        }  
        // å–éšæœºå€¼  
        double random = Math.random() * countWeight;  
        // åˆ†åŒºé—´åŒ¹é…  
        int preWeight = 0;  
        int currentWeight = 0;  
        for(Map.Entry<Integer,Integer> service : services.entrySet()){  
            currentWeight += service.getValue();  
            if(preWeight < random && random < currentWeight){  
                return service.getKey();  
            }  
            preWeight = currentWeight;  
        }  
        // è¿”å›é»˜è®¤å€¼  
        return services.entrySet().iterator().next().getKey();  
    }  
  
    public static void main(String[] args) {  
        int[] counts = new int[4];  
        for(int i=0;i<100;i++){  
            counts[loadBalance()]++;  
        }  
        System.out.println(Arrays.toString(counts));  
    }  
  
}
```

ç”±äºéšæœºå€¼æ— æ³•é¢„æµ‹ï¼Œæ‰€ä»¥åªèƒ½ä»æ¦‚ç‡ä¸Šå®ç°å¸¦æƒå€¼è½®è¯¢ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼æ˜¾ç„¶ä¸å¤ªé è°±ï¼Œä½†æ˜¯æ¬¡æ•°å¤šäº†ï¼Œéšæœºå€¼åˆ†å¸ƒä¹Ÿå°±æ›´å‡åŒ€äº†ã€‚

ä½†æ˜¯è¿™ç§æ–¹å¼çš„è¿˜æœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯ï¼Œæœ‰å¯èƒ½å¤§é‡çš„è¯·æ±‚ä¼šé›†ä¸­è¯·æ±‚åŒä¸€ä¸ªèµ„æºï¼Œè¿™æ—¶éšæœºå€¼çš„ä¸å¯é¢„æµ‹æ€§å¯¼è‡´çš„ã€‚æ‰€ä»¥æˆ‘ä»¬é€šå¸¸ä¸ä¼šç”¨è¿™ç§æ–¹å¼ï¼ˆä¹Ÿå°±æ˜¯æ‹¿å‡ºæ¥åšä¸€ä¸‹å¯¹æ¯”ğŸ˜‚ï¼‰

# æ™®é€šå¸¦æƒå€¼è½®è¯¢

æ™®é€šå¸¦æƒè½®è¯¢å°±æ¯”éšæœºå€¼çš„è¦å¥½å¤šäº†ï¼Œå®ƒå¯ä»¥ç²¾ç¡®çš„ä¿è¯æ¯ä¸ªèµ„æºæ‰¿å—çš„è¯·æ±‚è¾¾åˆ°é¢„æœŸã€‚

**ä»£ç å®ç°**
```java
public class WeightLoadBalance {  
  
    private static final Map<Integer, Integer> services = new ConcurrentHashMap<>();  
  
    private static int totalWeight;  
  
    static {  
        services.put(1, 1);  
        services.put(2, 3);  
        services.put(3, 2);  
        for(Map.Entry<Integer, Integer> service : services.entrySet()){  
            totalWeight += service.getValue();  
        }  
    }  
  
    private static int currentIndex = 0;  
  
    public static int loadBalance(){  
        currentIndex %= totalWeight;  
        int currentWeight = 0;  
        for(Map.Entry<Integer, Integer> service : services.entrySet()){  
            currentWeight += service.getValue();  
            if(currentIndex < currentWeight){  
                currentIndex ++;  
                return service.getKey();  
            }  
        }  
        return services.entrySet().iterator().next().getValue();  
    }  
  
    public static void main(String[] args) {  
        int[] count = new int[4];  
        for(int i=0;i<100;i++){  
            count[loadBalance()]++;  
        }  
        System.out.println(Arrays.toString(count));  
    }  
  
}
```

ä½†æ˜¯æ™®é€šå¸¦æƒå€¼è½®è¯¢ä¼šæœ‰è¿ç»­è¯·æ±‚åŒä¸€ä¸ªèµ„æºçš„æƒ…å†µï¼Œä¾‹å¦‚ï¼š

Aï¼ˆæƒå€¼5ï¼‰ã€Bï¼ˆæƒå€¼3ï¼‰ã€Cï¼ˆæƒå€¼2ï¼‰ï¼Œå°±ä¼šå‡ºç°ï¼š

`A-A-A-A-A-B-B-B-C-C`

è¿ç»­è¯·æ±‚äº†äº”æ¬¡çš„Aèµ„æºï¼Œè¯·æ±‚è¾ƒé›†ä¸­ã€‚

è€Œå¹³æ»‘å¸¦æƒå€¼è½®è¯¢å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

# å¹³æ»‘å¸¦æƒå€¼è½®è¯¢

æ¥ä¸Šï¼Œç”±äºæ™®é€šå¸¦æƒè½®è¯¢è´Ÿè½½å‡è¡¡å¯¼è‡´çš„è¿ç»­è¯·æ±‚åŒä¸€ä¸ªæœåŠ¡ï¼Œå¯¼è‡´è¯·æ±‚ä¸èƒ½åˆ†æ•£ã€‚è€Œä½¿ç”¨å¹³æ»‘è½®è¯¢åï¼Œè¯·æ±‚çš„é¡ºåºå˜ä¸ºäº†è¿™æ ·ï¼š

`A-A-B-C-A-A-B-C-A-B`

è¿™æ ·å°±å°†è¯·æ±‚åŒä¸€èµ„æºçš„è¯·æ±‚åˆ†æ•£å¼€äº†ï¼Œé¿å…å¤§é‡ç›¸åŒçš„è¯·æ±‚å †é›†åœ¨ä¸€èµ·è¯·æ±‚åŒä¸€ä¸ªã€‚

**å®ç°æ­¥éª¤**
1. æ¯ä¸ªèµ„æºæœ‰ä¸€ä¸ªæƒå€¼å’Œå½“å‰æƒå€¼ï¼Œå½“å‰æƒå€¼åˆå§‹åŒ–ä¸º0
2. .æ¯æ¬¡è¯·æ±‚æ—¶æ¯ä¸ªèµ„æºçš„å½“å‰æƒå€¼å˜ä¸ºå½“å‰æƒå€¼å’Œæƒå€¼çš„å’Œï¼ˆcurrentWeight += weight)
3. é€‰æ‹©æƒå€¼æœ€å¤§çš„ä¸€ä¸ªèµ„æºï¼Œç„¶åå°†æ­¤èµ„æºçš„å½“å‰æƒå€¼å‡æ‰æ€»æƒå€¼ï¼ˆcurrentWeight -= total Weightï¼ˆtotalWeightè¡¨ç¤ºåŸå§‹æƒåˆ¶çš„å’Œï¼‰ï¼‰

**ä»£ç å®ç°**
```java
public class SmoothWeightLoadBalance {  
  
    private static final Map<Integer, Integer> services = new ConcurrentHashMap<>();  
  
    private static int totalWeight;  
  
    private static final Map<Integer, Integer> currentWeights = new ConcurrentHashMap<>();  
  
    static {  
        services.put(1, 5);  
        services.put(2, 3);  
        services.put(3, 2);  
        for(Map.Entry<Integer, Integer> service : services.entrySet()){  
            totalWeight += service.getValue();  
        }  
        currentWeights.put(1, 0);  
        currentWeights.put(2, 0);  
        currentWeights.put(3, 0);  
    }  
  
    public static int loadBalance() {  
        int serviceId = services.entrySet().iterator().next().getKey();  
        int maxWeight = 0;  
        // æ‰¾å‡ºæƒå€¼æœ€å¤§èµ„æº  
        for(Map.Entry<Integer,Integer> service : services.entrySet()) {  
            // è®¡ç®—å‡ºç°æœ‰æƒå€¼å¹¶æ›´æ–°  
            int currentWeight = currentWeights.get(service.getKey()) + service.getValue();  
            currentWeights.put(service.getKey(), currentWeight);  
            // æœ€å¤§æƒå€¼  
            if(currentWeight > maxWeight){  
                serviceId = service.getKey();  
                maxWeight = currentWeight;  
            }  
        }  
        // æ›´æ–°æœ€å¤§æƒå€¼  
        currentWeights.put(serviceId, currentWeights.get(serviceId) - totalWeight);  
        return serviceId;  
    }  
  
    public static void main(String[] args) {  
        int[] count = new int[4];  
        for(int i=0;i<1000;i++){  
            count[loadBalance()]++;  
        }  
        System.out.println(Arrays.toString(count));  
    }  
  
}
```

